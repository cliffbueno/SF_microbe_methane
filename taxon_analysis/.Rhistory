theme_bw()
# Show trends by estuary
pdf("InitialFigs/Comb_All_CH4_Salinity.pdf", width = 9, height = 4)
ggplot(metaComb, aes(Salinity_ppt_all, CH4_ug_m2_h)) +
geom_point(aes(color = Estuary)) +
geom_smooth(method = "lm") +
scale_y_log10() +
scale_color_viridis_d() +
facet_wrap(~ Estuary, ncol = 4) +
labs(x = "Salinity (ppt)",
y = "CH4 (ug/m2/h)") +
theme_bw()
# Show trends by estuary
pdf("InitialFigs/Comb_All_CH4_Salinity.pdf", width = 9, height = 4)
dev.off()
# Show trends by estuary
pdf("InitialFigs/Comb_All_CH4_Salinity.pdf", width = 9, height = 4)
pdf("InitialFigs/Comb_All_CH4.pdf", width = 7, height = 5)
dev.off()
#### Setup ####
suppressMessages(library(dplyr))
suppressMessages(library(rlang))
suppressMessages(library(tibble))
library(mctoolsr)
library(pheatmap)
library(RColorBrewer)
`%notin%` <- Negate(`%in%`)
setwd("~/Documents/GitHub/SF_microbe_methane/taxon_analysis/")
setwd("~/Documents/GitHub/SF_microbe_methane/taxon_analysis/")
# Data Imports From Wyatt
# Import OTU Table
SilvaOTUs <- read.table("../silvaOTUs/Silva_OTU_VSTcpm.txt", sep='\t')
row.names(SilvaOTUs) <- SilvaOTUs[,"OTU"]
SilvaOTUs <- SilvaOTUs[,-1]
otu_V <- SilvaOTUs
# Sort OTU table
otu_V <- otu_V[order(otu_V$Consensus.lineage),]
# Make new top level plotting var (should be in PRE-PROCESS ? )
otu_V$Taxonomy <- ifelse(otu_V$Phylum == "Proteobacteria", paste(otu_V$Class), paste(otu_V$Phylum))
otu_V <- data.frame(otu_V)
# METADATA
metaDB <-read.table("../data/meta/SF_sal_meta_FIX3.txt", sep="\t", header=TRUE)
# Prune metadata to only iTag samples
# Get Sample names in OTU table
OTU_samps <- data.frame('Sample'=colnames(otu_V))
# Get aggregated guild counts by sample
guilds <- read.table("../guild_analysis/Silva_OTU_Guild_abundT_counts.txt", sep = "\t") %>%
select(1:17) %>%
rownames_to_column(var = "Sample")
# Merge site order and Samples,  log transform, merge guilds
Meta_iTag <- merge(metaDB, OTU_samps, by='Sample') %>%
select(Sample, Location, SALTgroup, CH4_ug_m2_h, SO4, Salinity.x, CO2_mg_m2_h) %>%
column_to_rownames(var = "Sample") %>%
mutate(Sample = rownames(.)) %>%
mutate(Salinity = log10(Salinity.x),
SO4 = log10(SO4),
CH4_ug_m2_h = log10(CH4_ug_m2_h - (1.05*min(CH4_ug_m2_h))),
CO2_mg_m2_h = log10(CO2_mg_m2_h)) %>%
left_join(., guilds, by = "Sample") %>%
select(-Salinity.x) %>%
select(Sample, Location, SALTgroup, Salinity, SO4, CH4_ug_m2_h, CO2_mg_m2_h,
CH4_mix, CH4_me, everything())
# Get colors for colorbar. Note will need to make the env. vars white
Guild_cols <- read.table("../data/colors/Guild_color_palette.txt", sep='\t') %>%
select(Guild, G_index, color) %>%
set_names(c("Guild", "Index", "color")) %>%
mutate(Index = rev(Index)) %>%
add_row(Guild = "CH4_me", Index = 16, color = "#FDC086") %>%
add_row(Guild = "CH4_mix", Index = 17, color = "#FFFF99") %>%
add_row(Guild = "CO2_mg_m2_h", Index = 18, color = "white") %>%
add_row(Guild = "CH4_ug_m2_h", Index = 19, color = "white") %>%
add_row(Guild = "SO4", Index = 20, color = "white") %>%
add_row(Guild = "Salinity", Index = 21, color = "white") %>%
arrange(-Index) %>%
mutate(Guild = gsub("MeOB", "ANME", Guild))
# Cor matrix
vars <- Meta_iTag %>%
select(4:24)
names(vars) == Guild_cols$Guild
sum(names(vars) != Guild_cols$Guild)
cm <- cor(vars)
mycolors <- colorRampPalette(brewer.pal(11, "RdBu"))(100)
ann_rows <- data.frame(row.names = rownames(cm),
"colorbar.r" = Guild_cols$Guild)
ann_cols <- data.frame(row.names = rownames(cm),
"colorbar.c" = Guild_cols$Guild)
ann_colors <- list(colorbar.r = c(Salinity = Guild_cols$color[1],
SO4 = Guild_cols$color[2],
CH4_ug_m2_h = Guild_cols$color[3],
CO2_mg_m2_h = Guild_cols$color[4],
CH4_mix = Guild_cols$color[5],
CH4_me = Guild_cols$color[6],
CH4_H2 = Guild_cols$color[7],
CH4_ac = Guild_cols$color[8],
MOB_I = Guild_cols$color[9],
MOB_II = Guild_cols$color[10],
MOB_IIa = Guild_cols$color[11],
ANME = Guild_cols$color[12],
AOA = Guild_cols$color[13],
AOB = Guild_cols$color[14],
NOB = Guild_cols$color[15],
Anamx = Guild_cols$color[16],
SOxB = Guild_cols$color[17],
SRB_syn = Guild_cols$color[18],
SRB = Guild_cols$color[19],
FeOB = Guild_cols$color[20],
FeRB = Guild_cols$color[21]),
colorbar.c = c(Salinity = Guild_cols$color[1],
SO4 = Guild_cols$color[2],
CH4_ug_m2_h = Guild_cols$color[3],
CO2_mg_m2_h = Guild_cols$color[4],
CH4_mix = Guild_cols$color[5],
CH4_me = Guild_cols$color[6],
CH4_H2 = Guild_cols$color[7],
CH4_ac = Guild_cols$color[8],
MOB_I = Guild_cols$color[9],
MOB_II = Guild_cols$color[10],
MOB_IIa = Guild_cols$color[11],
ANME = Guild_cols$color[12],
AOA = Guild_cols$color[13],
AOB = Guild_cols$color[14],
NOB = Guild_cols$color[15],
Anamx = Guild_cols$color[16],
SOxB = Guild_cols$color[17],
SRB_syn = Guild_cols$color[18],
SRB = Guild_cols$color[19],
FeOB = Guild_cols$color[20],
FeRB = Guild_cols$color[21]))
pheatmap(cm,
color = mycolors,
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors)
pheatmap(cm,
color = -mycolors,
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors)
pheatmap(cm,
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors)
pheatmap(cm,
legend = F,
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors)
pheatmap(cm,
legend = F,
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
fontsize_number = 6)
pheatmap(cm,
legend = F,
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
fontsize_number = 6,
number_color = ifelse(abs(cm) > 0.5, "white", "black"))
e <- pheatmap(cm,
legend = F,
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
fontsize_number = 6,
number_color = ifelse(abs(cm) > 0.5, "white", "black"))
e
View(cm)
cm[cm == 1.00]
View(cm)
cm[cm == 1.00] <- 1
e <- pheatmap(cm,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
fontsize_number = 6,
number_color = ifelse(abs(cm) > 0.5, "white", "black"))
e
e <- pheatmap(cm,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
fontsize = 8,
fontsize_number = 6,
number_color = ifelse(abs(cm) > 0.5, "white", "black"))
e <- pheatmap(cm,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm == 1, "%.0f", "%.2f"),
fontsize = 8,
fontsize_number = 6,
number_color = ifelse(abs(cm) > 0.5, "white", "black"))
library(cowplot)
e <- pheatmap(cm,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm == 1, "%.0f", "%.2f"),
fontsize = 6,
fontsize_number = 4,
number_color = ifelse(abs(cm) > 0.5, "white", "black"))
View(Meta_iTag)
#### _Delta ####
Meta_iTag_d <- Meta_iTag %>%
filter(SALTgroup == "FW" | SALTgroup == "Oligo")
# Cor matrix
vars_d <- Meta_iTag_d %>%
select(4:24)
sum(names(vars_d) != Guild_cols$Guild)
cm_d <- cor(vars)
f <- pheatmap(cm_d,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm == 1, "%.0f", "%.2f"),
fontsize = 6,
fontsize_number = 4,
number_color = ifelse(abs(cm) > 0.5, "white", "black"))
f
cm_d <- cor(vars_d)
f <- pheatmap(cm_d,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm == 1, "%.0f", "%.2f"),
fontsize = 6,
fontsize_number = 4,
number_color = ifelse(abs(cm) > 0.5, "white", "black"))
f
f <- pheatmap(cm_d,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm_d == 1, "%.0f", "%.2f"),
fontsize = 6,
fontsize_number = 4,
number_color = ifelse(abs(cm_d) > 0.5, "white", "black"))
f
#### _Combine ####
FigS5_forPPT <- plot_grid(e, f, labels = c("e", "f"))
pheatmap(cm_d,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm_d == 1, "%.0f", "%.2f"),
fontsize = 6,
fontsize_number = 4,
number_color = ifelse(abs(cm_d) > 0.5, "white", "black"),
filename = "../figs/FigureS5f.png", width = 2.25, height = 2.25)
pheatmap(cm_d,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm_d == 1, "%.0f", "%.2f"),
fontsize = 4,
fontsize_number = 2,
number_color = ifelse(abs(cm_d) > 0.5, "white", "black"),
filename = "../figs/FigureS5f.png", width = 2.25, height = 2.25)
pheatmap(cm,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm == 1, "%.0f", "%.2f"),
fontsize = 4,
fontsize_number = 2,
number_color = ifelse(abs(cm) > 0.5, "white", "black"),
filename = "../figs/FigureS5e.png", width = 2.25, height = 2.25)
pheatmap(cm,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm == 1, "%.0f", "%.2f"),
fontsize = 3,
fontsize_number = 2,
number_color = ifelse(abs(cm) > 0.5, "white", "black"),
filename = "../figs/FigureS5e.png", width = 2.25, height = 2.25)
pheatmap(cm_d,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm_d == 1, "%.0f", "%.2f"),
fontsize = 3,
fontsize_number = 2,
number_color = ifelse(abs(cm_d) > 0.5, "white", "black"),
filename = "../figs/FigureS5f.png", width = 2.25, height = 2.25)
save_pheatmap_pdf <- function(x, filename, width = 2.5, height = 2.5) {
stopifnot(!missing(x))
stopifnot(!missing(filename))
pdf(filename, width=width, height=height)
grid::grid.newpage()
grid::grid.draw(x$gtable)
dev.off()
}
f <- pheatmap(cm_d,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm_d == 1, "%.0f", "%.2f"),
fontsize = 3,
fontsize_number = 2,
number_color = ifelse(abs(cm_d) > 0.5, "white", "black"))
save_pheatmap_pdf(f, "../figs/FigureS5f.pdf")
e <- pheatmap(cm,
legend = F,
scale = "none",
color = rev(mycolors),
cluster_cols = F,
cluster_rows = F,
angle_col = 90,
border_color = NA,
annotation_row = ann_rows,
annotation_col = ann_cols,
annotation_colors = ann_colors,
annotation_legend = F,
annotation_names_row = F,
annotation_names_col = F,
display_numbers = T,
number_format = ifelse(cm == 1, "%.0f", "%.2f"),
fontsize = 3,
fontsize_number = 2,
number_color = ifelse(abs(cm) > 0.5, "white", "black"))
save_pheatmap_pdf(e, "../figs/FigureS5e.pdf")
